<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>INDRA DepMap Explainer</title>

  <!-- JS libraries -->
  <!-- JQ -->
  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <!-- BS 4.1.3 -->
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  
  <!-- Links -->
  <!-- BS 4.1.3 css -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

  <style type="text/css">
    a {
      target-new: tab;
    }
  </style>

  <!-- custom scripts -->
  <script type="text/javascript">
    const SUBMIT_URL = 'http://localhost:5000/query/submit';
    const INDRA_DB_URL_HASH = 'https://db.indra.bio/statements/from_hash/';

    function submitQuery() {
      if (!document.getElementById('path-length').value) {
        alert('Please select a path length');
        return;
      }
      let beliefEntry = parseFloat(document.getElementById('belief-cutoff').value || 0);
      if (beliefEntry < 0 || beliefEntry > 1) {
        alert('Enter a belief score between 0 and 1');
        return;
      }
      var statusBox = document.getElementById('query-status');
      let queryDict = {
        source: document.getElementById('source').value,
        target: document.getElementById('target').value,
        path_length: document.getElementById('path-length').value,
        spec_len_only: document.getElementById('selected-length-only').checked,
        sign: document.getElementById('sign-dd').value,
        weighted: document.getElementById('weighted-search').checked,
        bsco: beliefEntry,
        direct_only: document.getElementById('direct-only').checked,
        curated_db_only: document.getElementById('curated-db-only').checked,
        parents: document.getElementById('parents').checked,
        simple: false
        // simple: true // What we really want
      }
      let _url = SUBMIT_URL
      statusBox.textContent = 'Query submitted...'
      let response = $.ajax({
        url: _url,
        type: 'POST',
        dataType: 'json',
        contentType: 'application/json',
        data: JSON.stringify(queryDict),
        complete: function(xhr, statustText) {
          switch (xhr.status) {
            case 200:
              statusBox.textContent = 'Query resolved!';
              break;
            default:
              console.log('Submission error: check ajax response');
              statusBox.textContent = 'Submission error:' + xhr.status;
              break;
          }
        }

      })
      console.log(response)
      response.then(function(json){
        clearAllTables()
        fillResultsTable(json)
      })
    }

    function fillResultsTable(data){
      console.log(data)
      if (Object.keys(data.result).length > 0) {
        // for each path length:
        //   for each path:
        //     Output: path | list supporting statements per edge
        let pathsKeyedArray = data.result.paths_by_node_count;

        for (len in pathsKeyedArray) {
          let tableBody = document.getElementById('query-results-' + (len-1))
          console.log(tableBody.id)
          for (pathArray of pathsKeyedArray[len]) {
            let newRow = document.createElement('tr');
            // Add current path
            let newPath = document.createElement('td');
            newPath.innerHTML = pathArray.path.join('&rarr;');
            newRow.appendChild(newPath)

            let newSupport = document.createElement('td');
            newSupport.innerHTML = generatePathLinkout(pathArray.stmts)
            newRow.appendChild(newSupport)

            tableBody.appendChild(newRow);
          }
        }
      } else {
        document.getElementById('query-status').textContent = 'No path found!'
      }
    }

    function clearAllTables() {
      for (tb of document.getElementsByClassName('table-body')) {
        tb.innerHTML = null;
      }
    }

    function isNumeric(n) {
      return !isNaN(parseFloat(n)) && isFinite(n);
    }

    // Function to put stmts from path in a HTML format with linkouts
    function generatePathLinkout(stmtsArray) {
      // Build an html string of the paths
      // stmtsArray is a list of lists:
      // stmtsArray[i] gives edge i
      // stmtsArray[i][j] gives stmt j of edge i
      let htmlString = ''
      for (edgeList of stmtsArray) {
        htmlString += '<b>' + edgeList[0].subj + ' &rarr; ' + 
          edgeList[0].obj + '</b><span class="badge badge-secondary badge-pill float-right">Support: ' + edgeList.length + '</span><br>'
        for (stmt of edgeList) {
          let dbLink = INDRA_DB_URL_HASH + stmt.stmt_hash + 
            '?format=html'
          htmlString += '<a href="' + dbLink + '" target="_blank">' + stmt.subj + ', ' + 
            stmt.stmt_type + ', ' + stmt.obj + '</a><br>'
        }
      }
      return htmlString.substring(0, htmlString.length-4);
    }

  </script>
  <style>
    h3 a.stmt_toggle {
      cursor: pointer;
      color: #000000;
    }    
  </style>
</head>
<body>
  <div class="container">
    <h1 class="display-5" style="padding-top: 15px; padding-bottom: 15px;">INDRA Gene Dependency Explainer 2.0</h1>
  </div>
  <div class="container">
    <h2 class="display-6">Enter search</h2>
    <form>
      <div class="row">
        <div class="col">
          <input type="text" id="source" class="form-control" placeholder="Enter source">
        </div>
        <div class="col">
          <input type="text" id="target" class="form-control" placeholder="Enter target">
        </div>
      </div>
      <div class="row" style="padding-top: 5px;">
        <div class="dropdown" style="padding-left: 15px; padding-right: 15px;">
          <select id="path-length">
            <option value="" selected="selected" disabled="disabled" hidden="hidden">Max path length</option>
            <option value=1>1</option>
            <option value=2>2</option>
            <option value=3>3</option>
            <option value=4>4</option>
            <option value=5>5</option>
          </select>
        </div>
        <div class="custom-control custom-checkbox">
          <input type="checkbox" class="custom-control-input" id="selected-length-only">
          <label class="custom-control-label" for="selected-length-only">Check for selected length only</label>
        </div>
      </div>
      <div class="row" style="padding-top: 5px;">
        <div class="dropdown" style="padding-left: 15px; padding-right: 15px;">
          <label><select id="sign-dd" disabled>
            <option selected="selected" value="no_sign">No sign</option>
            <option value="plus">+</option>
            <option value="minus">-</option>
          </select>&nbsp;&nbsp;Sign</label>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label><div class="container" style="width: 90px; float: left; padding: 0px;">
            <input class="form-control" type="number" step="0.01" name="belief_cutoff" id="belief-cutoff" min="0" max="1">
          </div>&nbsp;&nbsp;Belief Score cut-off (0 to 1)</label>
        </div>
      </div>
      <div class="custom-control custom-checkbox">
        <input type="checkbox" class="custom-control-input" id="direct-only" disabled>
        <label class="custom-control-label" for="direct-only">Direct only</label>
      </div>
      <div class="custom-control custom-checkbox">
        <input type="checkbox" class="custom-control-input" id="simple-paths" disabled>
        <label class="custom-control-label" for="simple-paths">Simple path search</label>
      </div>
      <div class="custom-control custom-checkbox">
        <input type="checkbox" class="custom-control-input" id="weighted-search">
        <label class="custom-control-label" for="weighted-search">Weighted search</label>
      </div>
      <div class="custom-control custom-checkbox">
        <input type="checkbox" class="custom-control-input" id="curated-db-only" disabled>
        <label class="custom-control-label" for="curated-db-only">Curated databases only</label>
      </div>
      <div class="custom-control custom-checkbox">
        <input type="checkbox" class="custom-control-input" id="parents" disabled>
        <label class="custom-control-label" for="parents">Include FamPlex families and complexes</label>
      </div>
      <button style="margin-top: 16px; margin-bottom: 16px" type="button" class="btn btn-primary" onclick="submitQuery()">Submit query</button>
    </form>
  </div>
  <div class="container">
    <p><i id="query-status">Some settings are currently unavailable</i></p>
  </div>

  <div class="container">
    <h2 class="display-6">Search Results</h2>
    <!-- Direct paths: a-b -->
    <div class="card">
      <div class="card-header">
        <h3 class="display-7">
          <a href="#"
             class="stmt_toggle"
             data-toggle="collapse"
             data-target="#collapse-paths-1"
             aria-expanded="false" 
             aria-controls="collapse-paths-1">
            Direct Paths (A&rarr;B)
          </a>
          <span id="npaths-1" class="badge badge-primary badge-pill float-right">Paths: 0</span>

        </h3>
      </div>
      <div id="collapse-paths-1" class="collapse">
        <div class="card-body">
          <table class="table">
            <thead class="table-head">
              <th>Path</th>
              <th>Support</th>
            </thead>
            <tbody class="table-body" id="query-results-1"></tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- Path len 2: a-b-c -->
    <div class="card">
      <div class="card-header">
        <h3 class="display-7">
          <a href="#"
             class="stmt_toggle"
             data-toggle="collapse"
             data-target="#collapse-paths-2"
             aria-expanded="false" 
             aria-controls="collapse-paths-2">
            2-Edge Paths (A&rarr;U&rarr;B)
          </a>
          <span id="npaths-2" class="badge badge-primary badge-pill float-right">Paths: 0</span>
        </h3>
      </div>
      <div id="collapse-paths-2" class="collapse">
        <div class="card-body">
          <table class="table">
            <thead class="table-head">
              <th>Path</th>
              <th>Support</th>
            </thead>
            <tbody class="table-body" id="query-results-2"></tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- Path len 3: a-b-c-d -->
    <div class="card">
      <div class="card-header">
        <h3 class="display-7">
          <a href="#"
             class="stmt_toggle"
             data-toggle="collapse"
             data-target="#collapse-paths-3"
             aria-expanded="false" 
             aria-controls="collapse-paths-3">
            3-Edge Paths (A&rarr;U&rarr;V&rarr;B)
          </a>
          <span id="npaths-3" class="badge badge-primary badge-pill float-right">Paths: 0</span>
        </h3>
      </div>
      <div id="collapse-paths-3" class="collapse">
        <div class="card-body">
          <table class="table">
            <thead class="table-head">
              <th>Path</th>
              <th>Support</th>
            </thead>
            <tbody class="table-body" id="query-results-3"></tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- Path len 4: a-b-c-d -->
    <div class="card">
      <div class="card-header">
        <h3 class="display-7">
          <a href="#"
             class="stmt_toggle"
             data-toggle="collapse"
             data-target="#collapse-paths-4"
             aria-expanded="false" 
             aria-controls="collapse-paths-4">
            4-Edge Paths (A&rarr;U&rarr;V&rarr;X&rarr;B)
          </a>
          <span id="npaths-4" class="badge badge-primary badge-pill float-right">Paths: 0</span>
        </h3>
      </div>
      <div id="collapse-paths-4" class="collapse">
        <div class="card-body">
          <table class="table">
            <thead class="table-head">
              <th>Path</th>
              <th>Support</th>
            </thead>
            <tbody class="table-body" id="query-results-4"></tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- Path len 5: a-b-c-d-e-f -->
    <div class="card">
      <div class="card-header">
        <h3 class="display-7">
          <a href="#"
             class="stmt_toggle"
             data-toggle="collapse"
             data-target="#collapse-paths-5"
             aria-expanded="false" 
             aria-controls="collapse-paths-5">
            5-Edge Paths (A&rarr;U&rarr;V&rarr;X&rarr;Y&rarr;B)
          </a>
          <span id="npaths-5" class="badge badge-primary badge-pill float-right">Paths: 0</span>
        </h3>
      </div>
      <div id="collapse-paths-5" class="collapse">
        <div class="card-body">
          <table class="table">
            <thead class="table-head">
              <th>Path</th>
              <th>Support</th>
            </thead>
            <tbody class="table-body" id="query-results-5"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer text-muted" id="about" style="background: #F5F5F5;">
    <div class="container">
      <h5 class="my-0 mr-md-auto font-weight-normal">About</h5>
      <small>
        <p class="float-right">
          <a href="#">Back to top</a>
        </p>
        <p><a href="https://indralab.github.io" target="_blank">INDRALAB</a></p>
        <p><a href="http://hits.harvard.edu" target="_blank">Harvard Program in Therapeutic Science (HiTS)</a></p>
        <p><b>Automated Scientific Discovery Framework </b>(ASDF)<br>The DARPA ASDF project develops algorithms and software for reasoning about complex mechanisms operating in the natural world, explaining large-scale data, assisting humans in generating actionable, model-based hypotheses and testing these hypotheses empirically.<br><i>ASDF is funded by the Defense Advanced Research Projects Agency under award W911NF018-1-0124.</i></p>
      </small>
    </div>
  </footer>
</body>
</html>
